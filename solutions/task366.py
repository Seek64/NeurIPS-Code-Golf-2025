def p(s):t=len(s)>len(s[0]);s=[[*r]for r in(s,zip(*s))[t]];u,y=len(s),len(s[0])>>1;r,s=sorted([[r[:y]for r in s],[r[y:]for r in s]],key=lambda s:len(set(sum(s,[]))));n,p=sorted(set(z:=sum(s,[])),key=z.count)[-2:];x=max(set(z:=sum(r,[])),key=z.count);[exec('for r in s[e:e+t]:r[a:a+d]=[p]*d')or[all(r[o+p][a:a+d]==[(r,x)[r==n]for r in f[p]]for p in range(t))and exec('for p in range(t):r[o+p][a:a+d]=f[p]')for o in range(u-t+1)for a in range(y-d+1)]for o in range(3,0,-1)for e in range(u)for a in range(y)for t in range(u-e,0,-1)for d in range(y-a,0,-1)if p not in(z:=sum(f:=[r[a:a+d]for r in s[e:e+t]],[]))and t*d-z.count(n)==o];return(r,[*zip(*r)])[t]