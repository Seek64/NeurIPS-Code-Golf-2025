*Z,h=(0,)*3,lambda g,d=3:[[x and sum({*q+r+s}-{5})for x in 3*r][d:3+d]for q,r,s in zip(Z+g,g,g[1:]+Z)if Z<[r]or(d:=d-[*q,5].index(5)+[*s,5].index(5))*0]
p=lambda g:[*zip(*h([*zip(*g)]))]